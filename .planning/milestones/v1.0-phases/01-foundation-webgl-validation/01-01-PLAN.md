---
phase: 01-foundation-webgl-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Packages/manifest.json
  - Assets/Scripts/ECS/Components/GameStateComponents.cs
  - Assets/Scripts/MonoBehaviours/Core/ECSBootstrap.cs
  - Assets/Scripts/MonoBehaviours/Bridge/InputBridge.cs
  - Assets/Scripts/Shared/GameEnums.cs
  - Assets/Scripts/Shared/NumberFormatter.cs
  - Assets/Scripts/Shared/WebGLHelper.cs
  - Assets/Plugins/WebGL/IndexedDBSync.jslib
  - Assets/Materials/SkyboxMaterial.mat
  - Assets/Textures/Skybox/skybox_placeholder.png
  - Assets/Settings/SampleSceneProfile.asset
  - Assets/Scenes/Game.unity
autonomous: true
requirements:
  - INFRA-01
  - INFRA-05
  - INFRA-06
  - VISL-01
  - VISL-02

must_haves:
  truths:
    - "ECS world bootstraps automatically and singleton entities (GameStateData, InputData) exist after scene loads"
    - "Mouse position is projected to world space via perspective camera and written to ECS InputData singleton every frame"
    - "Large numbers format correctly with K/M/B/T suffixes (999 -> 999, 1500 -> 1.5K, 2500000 -> 2.5M)"
    - "Starfield skybox renders as dark void with sparse warm-toned stars"
    - "URP post-processing (bloom + neutral tonemapping) is active and visible on emissive objects"
    - "WebGL IndexedDB flush function exists and compiles for WebGL builds"
  artifacts:
    - path: "Assets/Scripts/ECS/Components/GameStateComponents.cs"
      provides: "GameStateData and InputData ECS singleton component structs"
      contains: "IComponentData"
    - path: "Assets/Scripts/MonoBehaviours/Core/ECSBootstrap.cs"
      provides: "Procedural ECS world bootstrap creating singleton entities"
      contains: "EntityManager"
    - path: "Assets/Scripts/MonoBehaviours/Bridge/InputBridge.cs"
      provides: "Mouse-to-world-space projection writing to ECS InputData singleton"
      contains: "ScreenPointToRay"
    - path: "Assets/Scripts/Shared/NumberFormatter.cs"
      provides: "K/M/B/T large number formatting utility"
      contains: "Format"
    - path: "Assets/Plugins/WebGL/IndexedDBSync.jslib"
      provides: "JavaScript bridge for IndexedDB flush on WebGL"
      contains: "SyncIndexedDB"
  key_links:
    - from: "Assets/Scripts/MonoBehaviours/Core/ECSBootstrap.cs"
      to: "Assets/Scripts/ECS/Components/GameStateComponents.cs"
      via: "Creates singleton entities with GameStateData and InputData components"
      pattern: "CreateEntity.*GameStateData"
    - from: "Assets/Scripts/MonoBehaviours/Bridge/InputBridge.cs"
      to: "Assets/Scripts/ECS/Components/GameStateComponents.cs"
      via: "Writes mouse world position to InputData singleton each frame"
      pattern: "SetComponentData.*InputData"
---

<objective>
Bootstrap the ECS simulation world with hybrid bridge layer, input projection, number formatting utility, and space visual baseline.

Purpose: Establishes the foundational architecture -- ECS world with singleton components for cross-layer communication, InputBridge for mouse-to-world projection, and the visual environment (starfield skybox + URP post-processing) that all subsequent phases build on. Also installs the Entities package and removes unnecessary default packages.

Output: Running ECS world with GameStateData and InputData singletons, InputBridge writing mouse position every frame, NumberFormatter utility, WebGL IndexedDB flush plugin, starfield skybox, and bloom + tonemapping post-processing.
</objective>

<execution_context>
@C:/Users/max/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/max/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-webgl-validation/01-RESEARCH.md
@.planning/phases/01-foundation-webgl-validation/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Entities package, remove unnecessary packages, create ECS components and bootstrap</name>
  <files>
    Packages/manifest.json
    Assets/Scripts/Shared/GameEnums.cs
    Assets/Scripts/ECS/Components/GameStateComponents.cs
    Assets/Scripts/MonoBehaviours/Core/ECSBootstrap.cs
  </files>
  <action>
**Step 1: Update Packages/manifest.json**

Add `com.unity.entities` 1.4.4 to dependencies. Remove these unnecessary packages that add build size:
- `com.unity.ai.navigation`
- `com.unity.multiplayer.center`
- `com.unity.visualscripting`
- `com.unity.timeline`

Do NOT add `com.unity.entities.graphics` (WebGL incompatible). Collections, Burst, and Mathematics are pulled automatically as transitive dependencies.

**Step 2: Create Assets/Scripts/Shared/GameEnums.cs**

Define the `GamePhase` enum used across the project:
```csharp
public enum GamePhase
{
    Playing,
    Collecting,
    GameOver,
    Upgrading
}
```

**Step 3: Create Assets/Scripts/ECS/Components/GameStateComponents.cs**

Define two ECS singleton component structs:

`GameStateData : IComponentData` with fields:
- `GamePhase Phase`
- `float Timer`
- `long Credits` (use long; NumberFormatter handles display with double conversion)

`InputData : IComponentData` with fields:
- `float2 MouseWorldPos` (using Unity.Mathematics)
- `bool MouseValid`

Use `Unity.Entities` and `Unity.Mathematics` namespaces. Keep structs simple -- no methods, no constructors.

**Step 4: Create Assets/Scripts/MonoBehaviours/Core/ECSBootstrap.cs**

MonoBehaviour that runs in `Start()`:
1. Gets `World.DefaultGameObjectInjectionWorld` and its `EntityManager`
2. Creates a GameStateData singleton entity with `Phase = GamePhase.Playing`, `Timer = 0f`, `Credits = 0`
3. Creates an InputData singleton entity with `MouseWorldPos = float2.zero`, `MouseValid = false`
4. Logs "ECS Bootstrap complete: singletons created" to console

Use `EntityManager.CreateEntity(typeof(ComponentType))` and `SetComponentData` -- no SubScenes, no bakers. See research Pattern 1 and Pattern 2 for exact code structure.

Attach this script to a GameObject in the Game scene (document this in verify steps -- the executor will use CoPlay MCP or manual setup).
  </action>
  <verify>
Open Unity Editor. Wait for package import to complete (Entities 1.4.4 and transitive deps). Confirm no compile errors in Console. Enter Play mode in the Game scene. Check Console for "ECS Bootstrap complete: singletons created" log message. Use Unity Entity Debugger (Window > Entities > Hierarchy) to verify two singleton entities exist with GameStateData and InputData components. Confirm the removed packages (ai.navigation, multiplayer.center, visualscripting, timeline) are gone from Package Manager.
  </verify>
  <done>
ECS world auto-bootstraps. Two singleton entities exist (GameStateData with Phase=Playing, InputData with MouseValid=false). No compile errors. Unnecessary packages removed from manifest.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create InputBridge, NumberFormatter, WebGL helper, and set up space visuals</name>
  <files>
    Assets/Scripts/MonoBehaviours/Bridge/InputBridge.cs
    Assets/Scripts/Shared/NumberFormatter.cs
    Assets/Scripts/Shared/WebGLHelper.cs
    Assets/Plugins/WebGL/IndexedDBSync.jslib
    Assets/Materials/SkyboxMaterial.mat
    Assets/Textures/Skybox/
    Assets/Settings/SampleSceneProfile.asset
    Assets/Scenes/Game.unity
  </files>
  <action>
**Step 1: Create Assets/Scripts/MonoBehaviours/Bridge/InputBridge.cs**

MonoBehaviour that bridges mouse input to ECS every frame:

In `Start()`:
- Cache `Camera.main` as `_mainCamera` (avoid per-frame FindGameObjectWithTag)
- Get `EntityManager` from `World.DefaultGameObjectInjectionWorld`
- Cache the InputData singleton entity via `EntityManager.CreateEntityQuery(typeof(InputData)).GetSingletonEntity()`
- Create a `Plane` at Y=0 facing up (`new Plane(Vector3.up, Vector3.zero)`) for ray intersection

In `Update()`:
- Get mouse position via `Input.mousePosition`
- Create ray via `_mainCamera.ScreenPointToRay(mousePos)`
- Raycast against the gameplay plane: `if (_gameplayPlane.Raycast(ray, out float distance))`
- On hit: extract world point, write `new InputData { MouseWorldPos = new float2(worldPoint.x, worldPoint.z), MouseValid = true }` to singleton via `SetComponentData`
- On miss: write `InputData { MouseValid = false }`

See research "InputBridge: Mouse-to-World Projection" code example for exact implementation. The perspective camera with top-down angle means the ray is not perpendicular -- Plane.Raycast handles this correctly.

**Step 2: Create Assets/Scripts/Shared/NumberFormatter.cs**

Static utility class with `public static string Format(double value)`:
- Suffixes array: `["", "K", "M", "B", "T", "Qa", "Qi"]`
- Negative values: prepend "-" and format absolute value
- Values < 1000: return `value.ToString("F0")`
- Otherwise: divide by 1000 repeatedly, track magnitude index
- Values < 100 at current magnitude: show 1 decimal (e.g., "1.5K", "23.4M")
- Values >= 100: no decimal (e.g., "150K", "999B")

See research "Large Number Formatting Utility" code example. Use `double` parameter type for full idle-game range.

**Step 3: Create Assets/Plugins/WebGL/IndexedDBSync.jslib**

JavaScript plugin file:
```javascript
mergeInto(LibraryManager.library, {
    SyncIndexedDB: function () {
        FS.syncfs(false, function (err) {
            if (err) {
                console.error("IndexedDB sync failed:", err);
            }
        });
    }
});
```

**Step 4: Create Assets/Scripts/Shared/WebGLHelper.cs**

Static class with `FlushSaveData()` method:
- Use `#if UNITY_WEBGL && !UNITY_EDITOR` to conditionally compile
- Import `SyncIndexedDB` via `[DllImport("__Internal")]`
- Call `SyncIndexedDB()` inside the conditional block
- No-op on non-WebGL platforms

See research "WebGL IndexedDB Sync Plugin" code example.

**Step 5: Set up starfield skybox**

Generate or create a placeholder skybox texture. Options (in order of preference):
1. Use CoPlay MCP `generate_or_edit_images` to create a dark space skybox with sparse warm-toned stars
2. If MCP unavailable, create a simple dark procedural skybox via a Unity Skybox/Procedural shader as a temporary stand-in, configured with very dark colors

Create a Skybox material using `Skybox/Cubemap` shader (or `Skybox/Panoramic` if using a single equirectangular image). The skybox should be:
- Mostly black/very dark
- Sparse, warm-toned stars (amber/gold hue)
- No nebulae, no gas clouds, no bright central objects
- Resolution: 512x512 per face minimum

Apply the skybox material via Lighting Settings (Window > Rendering > Lighting):
- Environment > Skybox Material: the created material
- Environment Lighting > Source: Color (not Skybox -- keep ambient very dark)
- Ambient Color: very dark warm (#0A0805 or similar, slight golden warmth)
- Environment Reflections > Intensity Multiplier: 0

User decision: "Dark void with sparse scattered stars", "Fewer, brighter stars with lots of empty black space", "Warm amber accents", "Static skybox texture -- zero performance cost"

**Step 6: Configure URP post-processing**

Edit `Assets/Settings/SampleSceneProfile.asset` (the existing URP Volume Profile) or create a new Global Volume Profile:

Add **Bloom** override:
- Threshold: 0.8
- Intensity: 0.3
- Scatter: 0.6
- Tint: slight warm amber (~255, 240, 220)
- High Quality Filtering: OFF (WebGL performance)
- Downscale: Quarter
- Max Iterations: 4

Add **Tonemapping** override:
- Mode: Neutral (preserves warm amber colors without ACES hue shifting)

See research "Post-Processing Configuration" for rationale.

Ensure the Game scene has a Global Volume GameObject with this profile assigned, or that the default volume profile in URP settings has these overrides.

**Step 7: Configure the camera**

In the Game scene, set up the Main Camera:
- Perspective projection (not orthographic)
- Top-down angle looking down at the Y=0 gameplay plane (e.g., position Y=15-20, rotation X=60-75 degrees)
- The angle should give slight 3D depth to objects (user decision: "perspective camera with top-down angle -- slight 3D depth")
- Landscape 16:9 aspect ratio
- Post-processing enabled on the camera (check "Post Processing" on the URP Camera component)
- Clear Flags: Skybox

Attach `ECSBootstrap` and `InputBridge` MonoBehaviours to appropriate GameObjects in the scene (can be on the same "GameCore" object or separate).
  </action>
  <verify>
Enter Play mode in Game scene. Verify:
1. Skybox visible -- dark space with stars (or procedural dark sky as placeholder)
2. Post-processing active -- bloom glow visible if any emissive object is in scene (temporarily add an emissive cube to test, then remove)
3. Move mouse around -- no errors in Console from InputBridge
4. In Entity Debugger, select the InputData entity and observe MouseWorldPos values changing as mouse moves. MouseValid should be true when mouse is over the game area.
5. Create a test script or use Debug.Log in InputBridge to confirm world position values change correctly (X increases going right, Z increases going up in perspective top-down view)
6. Verify NumberFormatter: add a temporary Debug.Log in any Start() method: `Debug.Log(NumberFormatter.Format(1500))` should print "1.5K", `Debug.Log(NumberFormatter.Format(2500000))` should print "2.5M"
  </verify>
  <done>
InputBridge writes mouse world position to ECS InputData singleton every frame with correct perspective projection. NumberFormatter produces correct K/M/B/T output. WebGL IndexedDB flush plugin compiled. Starfield skybox renders dark void. URP bloom and neutral tonemapping active. Camera configured as perspective top-down at approximately 60-75 degree angle.
  </done>
</task>

</tasks>

<verification>
1. ECS world is running: Entity Debugger shows active World with GameStateData and InputData singleton entities
2. InputBridge works: Moving mouse changes InputData.MouseWorldPos values in real-time via Entity Debugger
3. NumberFormatter produces correct output for edge cases: 0, 999, 1000, 1500, 999999, 1000000, 1500000000
4. Skybox visible as dark space environment
5. Bloom visible on emissive test objects
6. No compile errors, no runtime exceptions in Console
7. All scripts in correct directory structure matching research-recommended layout
</verification>

<success_criteria>
- ECS world bootstraps with two singleton entities (GameStateData, InputData) -- verified in Entity Debugger
- Mouse world position updates every frame in ECS -- verified by observing changing InputData values
- NumberFormatter correctly formats numbers with K/M/B/T suffixes
- Dark starfield skybox with warm-toned stars renders in the scene
- URP bloom + neutral tonemapping post-processing active
- WebGL jslib plugin file exists and compiles without errors
- Entities 1.4.4 package installed, unnecessary packages removed
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-webgl-validation/01-01-SUMMARY.md`
</output>
