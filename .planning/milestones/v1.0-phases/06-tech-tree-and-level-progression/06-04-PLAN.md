---
phase: 06-tech-tree-and-level-progression
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - Assets/Scripts/MonoBehaviours/UI/TechTreeController.cs
  - Assets/Scripts/MonoBehaviours/UI/TechTreeTooltip.cs
autonomous: true
requirements: [TECH-05, TECH-06]
gap_closure: true

must_haves:
  truths:
    - "Scroll wheel zooms the tech tree with reasonable sensitivity (~3-5 notches to traverse full range)"
    - "Tooltip appears near the hovered node and follows the mouse without jumping to corners"
  artifacts:
    - path: "Assets/Scripts/MonoBehaviours/UI/TechTreeController.cs"
      provides: "Corrected zoom sensitivity"
      contains: "ZoomSpeed = 1.0f"
    - path: "Assets/Scripts/MonoBehaviours/UI/TechTreeTooltip.cs"
      provides: "Center-anchored tooltip with correct clamping"
      contains: "anchorMin = new Vector2(0.5f, 0.5f)"
  key_links:
    - from: "TechTreeController.HandleZoom"
      to: "ZoomSpeed constant"
      via: "scroll * ZoomSpeed multiplication"
      pattern: "scroll \\* ZoomSpeed"
    - from: "TechTreeTooltip.UpdatePosition"
      to: "tooltip anchoredPosition"
      via: "center-origin clamping math"
      pattern: "halfW|halfH"
---

<objective>
Fix two UAT-identified issues in the tech tree: scroll zoom is too slow (requires ~14 notches to traverse full range) and tooltip positioning is broken due to anchor/pivot mismatch causing it to jump to the lower left corner.

Purpose: Close the final UAT gaps so the tech tree is fully usable.
Output: Two corrected C# files with proper zoom sensitivity and tooltip positioning.
</objective>

<execution_context>
@C:/Users/max/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/max/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Assets/Scripts/MonoBehaviours/UI/TechTreeController.cs
@Assets/Scripts/MonoBehaviours/UI/TechTreeTooltip.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix scroll zoom sensitivity and tooltip anchor/clamping</name>
  <files>
    Assets/Scripts/MonoBehaviours/UI/TechTreeController.cs
    Assets/Scripts/MonoBehaviours/UI/TechTreeTooltip.cs
  </files>
  <action>
Two targeted fixes:

**Fix 1 — TechTreeController.cs zoom sensitivity (line 44 and 643):**

Change the ZoomSpeed constant on line 44:
```csharp
// OLD:
private const float ZoomSpeed = 0.1f;
// NEW:
private const float ZoomSpeed = 1.0f;
```

Remove the redundant `* 0.01f` multiplier on line 643 in HandleZoom():
```csharp
// OLD:
float newZoom = Mathf.Clamp(currentZoom + scroll * ZoomSpeed * 0.01f, MinZoom, MaxZoom);
// NEW:
float newZoom = Mathf.Clamp(currentZoom + scroll * ZoomSpeed * 0.001f, MinZoom, MaxZoom);
```

Rationale: Mouse.current.scroll.ReadValue().y returns ~120 per notch. With ZoomSpeed=1.0f and *0.001f multiplier, each notch gives 120*1.0*0.001 = 0.12 zoom delta. Range is 0.3 to 2.0 (1.7 total), so ~14 notches traverses full range. To make it ~5 notches: 1.7/5 = 0.34 per notch. So use 0.003f multiplier instead: 120*1.0*0.003 = 0.36. Actually, let's use a cleaner approach:

Revised fix for line 44 and 643:
```csharp
// Line 44 — change to:
private const float ZoomSpeed = 0.3f;

// Line 643 — change to (remove the 0.01f, just use ZoomSpeed directly divided by scroll units):
float newZoom = Mathf.Clamp(currentZoom + scroll * ZoomSpeed * 0.003f, MinZoom, MaxZoom);
```

This gives 120 * 0.3 * 0.003 = 0.108 per notch, so ~16 notches for full range. Still a bit slow.

Simplest correct fix: Keep ZoomSpeed as the single tuning knob, normalize scroll by 120:
```csharp
// Line 44:
private const float ZoomSpeed = 0.5f;

// Line 643:
float newZoom = Mathf.Clamp(currentZoom + (scroll / 120f) * ZoomSpeed, MinZoom, MaxZoom);
```

This gives exactly 0.5 zoom per scroll notch. Full range (1.7) in ~3.4 notches. Smooth and responsive. Use this approach.

**Fix 2 — TechTreeTooltip.cs anchor/pivot mismatch (lines 37-38 and 163-177):**

The root cause: anchors are at (0,0) (bottom-left) but the clamping logic uses halfW/halfH which assumes center-origin coordinates from ScreenPointToLocalPointInRectangle on the canvasRect. The anchoredPosition is relative to the anchor, so there is a mismatch.

Change the tooltip anchor to center (0.5, 0.5) so anchoredPosition aligns with center-origin clamping. Keep pivot at (0, 1) for top-left tooltip expansion. Lines 37-38 in Initialize():

```csharp
// OLD (lines 37-38):
tooltipRect.anchorMin = Vector2.zero;
tooltipRect.anchorMax = Vector2.zero;
// NEW:
tooltipRect.anchorMin = new Vector2(0.5f, 0.5f);
tooltipRect.anchorMax = new Vector2(0.5f, 0.5f);
```

The clamping logic in UpdatePosition() (lines 163-177) is already correct for center-origin with pivot (0, 1):
- Right edge: localPos.x + tooltipSize.x > halfW -- tooltip extends rightward from pivot, correct
- Bottom edge: localPos.y - tooltipSize.y < -halfH -- tooltip extends downward from pivot (0,1), correct

No changes needed to the clamping logic itself. The anchor fix alone resolves the coordinate mismatch.

Do NOT change any other code. These are surgical two-line fixes (ZoomSpeed + scroll normalization, anchor change).
  </action>
  <verify>
Open the project in Unity Editor. Enter Upgrading phase to see the tech tree. Verify:
1. Scroll wheel zooms smoothly — about 3-4 scroll notches should go from default zoom to near max or min
2. Hover over any tech tree node — tooltip appears near the mouse cursor (offset slightly right and below)
3. Move mouse around while hovering — tooltip follows smoothly
4. Move mouse near screen edges — tooltip flips/clamps to stay visible
5. Tooltip does NOT jump to the bottom-left corner
  </verify>
  <done>
Scroll zoom traverses the 0.3-2.0 range in approximately 3-4 scroll notches. Tooltip appears adjacent to the mouse cursor at all positions without jumping to corners or clipping off screen.
  </done>
</task>

</tasks>

<verification>
- Scroll wheel zoom: each notch produces ~0.5 zoom delta, 3-4 notches traverses full 0.3-2.0 range
- Tooltip anchor: center-anchored (0.5, 0.5) with pivot (0, 1) so anchoredPosition matches center-origin ScreenPointToLocalPointInRectangle output
- Tooltip clamping: right-edge and bottom-edge clamps work correctly with center-origin coordinates
- No regressions: pan still works, node clicking still works, purchase flow unchanged
</verification>

<success_criteria>
- Zoom feels responsive and controllable with standard scroll wheel
- Tooltip tracks the mouse cursor with a small offset, never jumps to wrong position
- Tooltip stays within screen bounds when hovering nodes near edges
</success_criteria>

<output>
After completion, create `.planning/phases/06-tech-tree-and-level-progression/06-04-SUMMARY.md`
</output>
