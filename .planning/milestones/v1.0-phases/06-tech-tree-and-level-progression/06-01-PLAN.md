---
phase: 06-tech-tree-and-level-progression
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Assets/Scripts/Data/UpgradeNodeSO.cs
  - Assets/Scripts/Data/TechTreeSO.cs
  - Assets/Scripts/Data/LevelConfigSO.cs
  - Assets/Scripts/Data/ResourceTierSO.cs
  - Assets/Scripts/Shared/GameEnums.cs
  - Assets/Scripts/ECS/Components/EconomyComponents.cs
  - Assets/Scripts/ECS/Components/SkillComponents.cs
  - Assets/Scripts/MonoBehaviours/Core/ECSBootstrap.cs
  - Assets/Scripts/MonoBehaviours/Save/SaveData.cs
  - Assets/Scripts/MonoBehaviours/Save/SaveManager.cs
  - Assets/Scripts/Shared/GameConstants.cs
autonomous: true
requirements: [TECH-02, TECH-03, TECH-04, TECH-05, TECH-06, TECH-08, TECH-10, LEVL-04, LEVL-05]

must_haves:
  truths:
    - "All tech tree data (5 branches, ~40 nodes, costs, effects, prerequisites) is defined in ScriptableObject classes"
    - "New ECS singletons (PlayerBonusData, RunConfigData) exist for economy bonuses and run duration modification"
    - "SaveData persists tech tree unlock state and all upgradeable stat values across sessions"
    - "Skills default to locked in ECSBootstrap (SkillUnlockData all false) ready for tech tree purchases"
    - "Level configs for 5 levels with drop tables, HP multipliers, and advance thresholds are defined in ScriptableObjects"
  artifacts:
    - path: "Assets/Scripts/Data/UpgradeNodeSO.cs"
      provides: "Individual upgrade node ScriptableObject with ID, cost, tier, prerequisites, stat effects, graph position"
      contains: "class UpgradeNodeSO"
    - path: "Assets/Scripts/Data/TechTreeSO.cs"
      provides: "Aggregation of all upgrade nodes plus the START node reference"
      contains: "class TechTreeSO"
    - path: "Assets/Scripts/Data/LevelConfigSO.cs"
      provides: "Per-level config: drop table, HP multiplier, spawn rate, advance threshold"
      contains: "class LevelConfigSO"
    - path: "Assets/Scripts/ECS/Components/EconomyComponents.cs"
      provides: "PlayerBonusData and RunConfigData ECS singletons"
      contains: "struct PlayerBonusData"
    - path: "Assets/Scripts/MonoBehaviours/Save/SaveData.cs"
      provides: "Expanded save schema with tech tree unlocks array and full player stats"
      contains: "bool[] TechTreeUnlocks"
  key_links:
    - from: "Assets/Scripts/Data/UpgradeNodeSO.cs"
      to: "Assets/Scripts/Shared/GameEnums.cs"
      via: "StatTarget and UpgradeBranch enums"
      pattern: "StatTarget|UpgradeBranch"
    - from: "Assets/Scripts/MonoBehaviours/Core/ECSBootstrap.cs"
      to: "Assets/Scripts/ECS/Components/EconomyComponents.cs"
      via: "Creating PlayerBonusData and RunConfigData singletons"
      pattern: "PlayerBonusData|RunConfigData"
    - from: "Assets/Scripts/MonoBehaviours/Save/SaveManager.cs"
      to: "Assets/Scripts/ECS/Components/EconomyComponents.cs"
      via: "LoadIntoECS restores economy bonuses and run duration from save"
      pattern: "PlayerBonusData|RunConfigData"
---

<objective>
Build the complete data foundation for the tech tree and level progression system: ScriptableObject class definitions for upgrade nodes, tech tree aggregation, and level configs; new ECS singletons for economy bonuses and run duration; expanded save system for full tech tree state persistence; and ECSBootstrap changes for locked-by-default skills.

Purpose: Everything in Phase 6 (the tech tree UI, purchase logic, level progression, and resource tiers) depends on having the data model, ECS singletons, and save system in place first. This plan creates the entire data layer so plans 06-02 and 06-03 can build on it in parallel.

Output: ScriptableObject classes, enum definitions, ECS components, expanded save schema, and modified bootstrap -- all compiling and ready for the UI and level systems to consume.
</objective>

<execution_context>
@C:/Users/max/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/max/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-tech-tree-and-level-progression/06-RESEARCH.md
@.planning/phases/06-tech-tree-and-level-progression/06-CONTEXT.md
@.planning/phases/05-ship-skills-and-advanced-damage/05-03-SUMMARY.md
@.planning/phases/03-collection-economy-and-session/03-03-SUMMARY.md
@Assets/Scripts/Data/ResourceTierSO.cs
@Assets/Scripts/ECS/Components/GameStateComponents.cs
@Assets/Scripts/ECS/Components/SkillComponents.cs
@Assets/Scripts/ECS/Components/AsteroidComponents.cs
@Assets/Scripts/ECS/Components/MineralComponents.cs
@Assets/Scripts/Shared/GameConstants.cs
@Assets/Scripts/Shared/GameEnums.cs
@Assets/Scripts/MonoBehaviours/Core/ECSBootstrap.cs
@Assets/Scripts/MonoBehaviours/Save/SaveData.cs
@Assets/Scripts/MonoBehaviours/Save/SaveManager.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ScriptableObject data model and enum definitions for tech tree and levels</name>
  <files>
    Assets/Scripts/Shared/GameEnums.cs
    Assets/Scripts/Data/UpgradeNodeSO.cs
    Assets/Scripts/Data/TechTreeSO.cs
    Assets/Scripts/Data/LevelConfigSO.cs
    Assets/Scripts/Data/ResourceTierSO.cs
    Assets/Scripts/ECS/Components/EconomyComponents.cs
    Assets/Scripts/Shared/GameConstants.cs
  </files>
  <action>
    **GameEnums.cs** -- Add two new enums:

    `UpgradeBranch` enum: Mining, Economy, Ship, Run, Progression

    `StatTarget` enum covering all modifiable stats:
    - Mining branch: MiningRadius, MiningDamage, MiningTickInterval, CritChance, CritMultiplier, DotDamage, DotDuration
    - Economy branch: ResourceMultiplier, LuckyStrikeChance, SpawnRateReduction, MaxAsteroidsBonus
    - Ship branch: SkillUnlock, LaserDamage, LaserCooldown, ChainDamage, ChainCooldown, ChainTargets, EmpDamage, EmpCooldown, EmpRadius, OverchargeCooldown, OverchargeDuration, OverchargeDamageMultiplier, ComboMastery
    - Run branch: RunDuration
    - Progression branch: AdvanceLevel

    **UpgradeNodeSO.cs** -- New ScriptableObject class (CreateAssetMenu: "AstroMiner/Upgrade Node"):
    - `string NodeId` -- unique ID for save persistence
    - `string DisplayName` -- e.g., "Circle Radius I"
    - `[TextArea] string Description` -- effect description for tooltip
    - `UpgradeBranch Branch`
    - `int BaseCost` -- base credit cost before tier multiplier
    - `int TierLevel` -- 1, 2, or 3 (maps to multipliers 1x, 3x, 8x per TECH-08)
    - `UpgradeNodeSO[] Prerequisites` -- nodes that must be purchased first (TECH-07)
    - `StatEffect[] Effects` -- array of stat modifications this node applies
    - `Vector2 GraphPosition` -- XY position in the center-outward graph layout
    - `int SkillIndex` -- only used when StatTarget is SkillUnlock (1-4 maps to skill slots)
    - Computed property: `public int ActualCost => BaseCost * TierMultipliers[Mathf.Clamp(TierLevel - 1, 0, 2)]` with static readonly int[] TierMultipliers = { 1, 3, 8 }

    `[Serializable] struct StatEffect`:
    - `StatTarget Target`
    - `float Value` -- additive or multiplicative depending on target

    **TechTreeSO.cs** -- New ScriptableObject class (CreateAssetMenu: "AstroMiner/Tech Tree"):
    - `UpgradeNodeSO StartNode` -- the center START node (free, already purchased)
    - `UpgradeNodeSO[] AllNodes` -- all upgrade nodes in the tree
    - Helper method: `int GetNodeIndex(string nodeId)` returns index matching AllNodes for save array indexing

    **LevelConfigSO.cs** -- New ScriptableObject class (CreateAssetMenu: "AstroMiner/Level Config"):
    - `int LevelNumber` (1-5)
    - `long AdvanceCreditThreshold` -- credits needed to buy the Advance node
    - `float AsteroidHPMultiplier` (1.0 for level 1, scaling up)
    - `float SpawnIntervalOverride` (-1 for default)
    - `ResourceTierWeight[] DropTable` -- weighted random for tier selection
    - `int MaxActiveAsteroidsOverride` (-1 for default)

    `[Serializable] struct ResourceTierWeight`:
    - `int TierIndex` (0=Iron through 5=Titanium)
    - `float Weight` (relative probability)

    **ResourceTierSO.cs** -- Already exists. No changes needed (already has TierName, TierIndex, CreditValue, MineralsPerAsteroid, MineralColor, EmissiveIntensity).

    **EconomyComponents.cs** -- New file in Assets/Scripts/ECS/Components/:
    - `struct PlayerBonusData : IComponentData` with fields:
      - `float ResourceMultiplier` (default 1.0 = no bonus)
      - `float LuckyStrikeChance` (default 0.0)
      - `float ComboMasteryMultiplier` (default 1.0)
      - `float ComboMasteryWindow` (default 5.0 seconds)
      - `float LastSkillUseTime` (tracking for combo)
      - `int SkillsUsedInWindow` (count for combo)
    - `struct RunConfigData : IComponentData` with fields:
      - `float RunDuration` (default from GameConstants.DefaultRunDuration)
      - `float SpawnInterval` (default from GameConstants.DefaultSpawnInterval)
      - `int MaxActiveAsteroids` (default from GameConstants.DefaultMaxAsteroids)
      - `float AsteroidHPMultiplier` (default 1.0)
      - `int CurrentLevel` (default 1)

    **GameConstants.cs** -- Add new constants section "Economy Defaults":
    - `public const float DefaultResourceMultiplier = 1f;`
    - `public const float DefaultLuckyStrikeChance = 0f;`
    - `public const float DefaultComboMasteryWindow = 5f;`
    - `public const float DefaultComboMasteryMultiplier = 1.5f;`

    Resource tier credit values (from research economy balance):
    - `public const int IronCreditValue = 10;`
    - `public const int CopperCreditValue = 25;`
    - `public const int SilverCreditValue = 75;`
    - `public const int CobaltCreditValue = 150;`
    - `public const int GoldCreditValue = 400;`
    - `public const int TitaniumCreditValue = 1000;`

    Ensure all new files are in the correct namespaces: Data for SOs, ECS.Components for ECS, and use System for [Serializable].
  </action>
  <verify>
    Open the project in Unity Editor (or verify no C# compilation errors via the Unity console). All new files should compile without errors. No existing tests should break. Verify:
    - GameEnums.cs has UpgradeBranch and StatTarget enums
    - UpgradeNodeSO.cs has CreateAssetMenu attribute and ActualCost computed property
    - TechTreeSO.cs has StartNode and AllNodes fields
    - LevelConfigSO.cs has all level config fields
    - EconomyComponents.cs has PlayerBonusData and RunConfigData structs implementing IComponentData
    - GameConstants.cs has new economy and resource tier constants
  </verify>
  <done>
    All ScriptableObject class definitions, enums, and ECS component structs compile without errors. The data model supports all 5 tech tree branches with prerequisite gating, tiered costs (1x/3x/8x), stat effects targeting all gameplay singletons, and level configs with drop tables. New ECS singletons defined for economy bonuses and run configuration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Expand ECSBootstrap, SaveData, and SaveManager for tech tree state</name>
  <files>
    Assets/Scripts/MonoBehaviours/Core/ECSBootstrap.cs
    Assets/Scripts/MonoBehaviours/Save/SaveData.cs
    Assets/Scripts/MonoBehaviours/Save/SaveManager.cs
    Assets/Scripts/ECS/Components/SkillComponents.cs
  </files>
  <action>
    **ECSBootstrap.cs** -- Add new singleton creation and change skill defaults:

    1. Change SkillUnlockData defaults from all true to all false:
       ```
       Skill1Unlocked = false,  // Was true -- Phase 6 locked-by-default
       Skill2Unlocked = false,
       Skill3Unlocked = false,
       Skill4Unlocked = false
       ```

    2. Create PlayerBonusData singleton:
       ```
       var playerBonusEntity = em.CreateEntity(typeof(PlayerBonusData));
       em.SetComponentData(playerBonusEntity, new PlayerBonusData
       {
           ResourceMultiplier = GameConstants.DefaultResourceMultiplier,
           LuckyStrikeChance = GameConstants.DefaultLuckyStrikeChance,
           ComboMasteryMultiplier = GameConstants.DefaultComboMasteryMultiplier,
           ComboMasteryWindow = GameConstants.DefaultComboMasteryWindow,
           LastSkillUseTime = 0f,
           SkillsUsedInWindow = 0
       });
       ```

    3. Create RunConfigData singleton:
       ```
       var runConfigEntity = em.CreateEntity(typeof(RunConfigData));
       em.SetComponentData(runConfigEntity, new RunConfigData
       {
           RunDuration = GameConstants.DefaultRunDuration,
           SpawnInterval = GameConstants.DefaultSpawnInterval,
           MaxActiveAsteroids = GameConstants.DefaultMaxAsteroids,
           AsteroidHPMultiplier = 1f,
           CurrentLevel = 1
       });
       ```

    4. Update the Debug.Log to include the new singletons.

    **SaveData.cs** -- Expand the save schema:

    1. Bump SaveVersion from 1 to 2.

    2. Expand `PlayerStatsData` class to include ALL upgradeable values with defaults matching GameConstants:
       - Mining: MiningRadius (2.5f), DamagePerTick (10f), TickInterval (0.25f), CritChance (0.08f), CritMultiplier (2f)
       - Economy: ResourceMultiplier (1f), LuckyStrikeChance (0f)
       - Run: RunDuration (20f)
       - Skills (mirror SkillStatsData defaults): LaserDamage (150f), LaserCooldown (8f), ChainDamage (60f), ChainCooldown (10f), ChainMaxTargets (4), ChainMaxDist (5f), EmpDamage (80f), EmpCooldown (12f), EmpRadius (4f), OverchargeCooldown (15f), OverchargeDuration (5f), OverchargeDamageMultiplier (2f), OverchargeRadiusMultiplier (1.5f)
       - DoT: LaserDotDamagePerTick (5f), LaserDotTickInterval (0.5f), LaserDotDuration (3f), EmpDotDamagePerTick (3f), EmpDotTickInterval (0.5f), EmpDotDuration (2f)
       - Combo: ComboMasteryMultiplier (1f -- 1.0 means no bonus until purchased)

    3. Add `bool[] SkillUnlocks = new bool[4]` (separate from TechTreeUnlocks for quick access).

    4. Add `int CurrentLevel = 1` (already exists, keep it).

    **SaveManager.cs** -- Expand AutoSave and LoadIntoECS:

    1. In `AutoSave()`: After saving credits, also save SkillUnlockData from ECS:
       - Read SkillUnlockData singleton, write to _currentSave.SkillUnlocks[0..3]
       - Read PlayerBonusData singleton, write to _currentSave.Stats.ResourceMultiplier, LuckyStrikeChance
       - Read RunConfigData singleton, write to _currentSave.Stats.RunDuration and _currentSave.CurrentLevel
       - Read MiningConfigData singleton, write to _currentSave.Stats.MiningRadius, DamagePerTick, TickInterval
       - Read CritConfigData singleton, write to _currentSave.Stats.CritChance, CritMultiplier
       - Read SkillStatsData singleton, write to _currentSave.Stats skill fields

    2. In `LoadIntoECS()`: After loading credits, also restore all singleton state from save:
       - If _currentSave.SkillUnlocks.Length == 4, set SkillUnlockData from save
       - If _currentSave.TechTreeUnlocks.Length > 0, the tree has been used (not a fresh save)
       - Restore MiningConfigData from Stats
       - Restore CritConfigData from Stats
       - Restore SkillStatsData from Stats
       - Restore PlayerBonusData from Stats
       - Restore RunConfigData from Stats + CurrentLevel

    3. Add save version migration: if loaded SaveVersion == 1 (pre-Phase-6), initialize all new fields to defaults and set SaveVersion = 2. This handles backward compatibility -- old saves get default stats (which match GameConstants), and skills stay unlocked via a migration flag: if TechTreeUnlocks.Length == 0, set all SkillUnlocks to true (backward compat, per research pitfall #1).

    4. Add a public `SaveTechTreeState(bool[] unlocks)` method that TechTreeController will call after each purchase to persist immediately.

    Use the existing lazy EntityQuery pattern (create query in method, check entity count > 0 before accessing). Follow the exact GetComponentData/SetComponentData pattern already established in LoadIntoECS.

    **IMPORTANT:** The SkillUnlockData changes (false defaults) combined with the save migration ensure:
    - Fresh new game: skills locked (Phase 6 behavior, must unlock via Ship branch)
    - Existing save with no tech tree data: skills stay unlocked (backward compat)
    - Existing save with tech tree data: skills reflect purchased state
  </action>
  <verify>
    Project compiles without errors. Verify:
    - ECSBootstrap creates PlayerBonusData and RunConfigData singletons
    - SkillUnlockData defaults to all false
    - SaveData.SaveVersion == 2, PlayerStatsData has all expanded fields
    - SaveManager.LoadIntoECS restores all singleton state
    - SaveManager handles version 1 saves gracefully (migration path)
  </verify>
  <done>
    ECSBootstrap creates all new singletons with correct defaults. Skills default to locked. SaveData schema expanded with all upgradeable stats. SaveManager persists and restores complete game state including tech tree unlocks, all stat modifications, and level. Version migration handles pre-Phase-6 saves without breaking existing progress.
  </done>
</task>

</tasks>

<verification>
1. All new files compile without Unity errors
2. GameEnums.cs contains UpgradeBranch and StatTarget enums with all required values
3. UpgradeNodeSO, TechTreeSO, LevelConfigSO classes have CreateAssetMenu attributes
4. EconomyComponents.cs has PlayerBonusData and RunConfigData implementing IComponentData
5. ECSBootstrap creates both new singletons and sets SkillUnlockData to all false
6. SaveData.SaveVersion == 2 with full PlayerStatsData expansion
7. SaveManager.LoadIntoECS restores all ECS singletons from save
8. SaveManager handles v1->v2 migration (old saves get default stats, skills stay unlocked)
</verification>

<success_criteria>
- All 9 files compile without errors
- Data model supports all 5 tech tree branches and their upgrade nodes
- Tier cost multipliers computed correctly (1x/3x/8x)
- New ECS singletons bootstrapped with GameConstants defaults
- Save system round-trips all upgradeable stats
- Pre-Phase-6 saves migrate cleanly without losing credits or breaking skills
</success_criteria>

<output>
After completion, create `.planning/phases/06-tech-tree-and-level-progression/06-01-SUMMARY.md`
</output>
