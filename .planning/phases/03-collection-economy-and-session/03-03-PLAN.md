---
phase: 03-collection-economy-and-session
plan: 03
type: execute
wave: 3
depends_on: [03-02]
files_modified:
  - Assets/Scripts/MonoBehaviours/Save/SaveData.cs
  - Assets/Scripts/MonoBehaviours/Save/SaveManager.cs
  - Assets/Scripts/States/GameOverState.cs
  - Assets/Scripts/States/PlayingState.cs
autonomous: true
requirements: [SAVE-01, SAVE-02, SAVE-03, SAVE-04, SAVE-05]

must_haves:
  truths:
    - "Game state saves to a JSON file on run end (GameOver transition)"
    - "Save file contains credits, current level, and version number"
    - "On game start, saved credits are loaded and restored to ECS singleton"
    - "WebGL builds flush IndexedDB after each save via WebGLHelper"
    - "Save file includes version number 1 for future migration support"
  artifacts:
    - path: "Assets/Scripts/MonoBehaviours/Save/SaveData.cs"
      provides: "Serializable save data class"
      contains: "SaveVersion"
    - path: "Assets/Scripts/MonoBehaviours/Save/SaveManager.cs"
      provides: "JSON save/load with WebGL IndexedDB flush"
      contains: "WebGLHelper"
  key_links:
    - from: "Assets/Scripts/MonoBehaviours/Save/SaveManager.cs"
      to: "Assets/Scripts/Shared/WebGLHelper.cs"
      via: "Calls FlushSaveData() after every File.WriteAllText"
      pattern: "FlushSaveData"
    - from: "Assets/Scripts/States/GameOverState.cs"
      to: "Assets/Scripts/MonoBehaviours/Save/SaveManager.cs"
      via: "Auto-save triggered on Enter"
      pattern: "SaveManager.*AutoSave\\|AutoSave"
    - from: "Assets/Scripts/States/PlayingState.cs"
      to: "Assets/Scripts/MonoBehaviours/Save/SaveManager.cs"
      via: "Load saved credits on first run start"
      pattern: "SaveManager.*Load\\|LoadGame"
---

<objective>
Save system: JSON persistence with auto-save on run end, credit restoration on game start, and WebGL IndexedDB compatibility.

Purpose: Without persistence, all progress is lost on browser refresh or application restart. This is the difference between a demo and a game.

Output: SaveData class, SaveManager MonoBehaviour, auto-save integration in GameOverState, load integration in PlayingState/ECSBootstrap.
</objective>

<execution_context>
@C:/Users/max/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/max/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-collection-economy-and-session/03-RESEARCH.md
@.planning/phases/03-collection-economy-and-session/03-01-SUMMARY.md
@.planning/phases/03-collection-economy-and-session/03-02-SUMMARY.md

@Assets/Scripts/Shared/WebGLHelper.cs
@Assets/Scripts/States/GameOverState.cs
@Assets/Scripts/States/PlayingState.cs
@Assets/Scripts/MonoBehaviours/Core/ECSBootstrap.cs
@Assets/Scripts/ECS/Components/GameStateComponents.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: SaveData class, SaveManager with JSON persistence and WebGL support, auto-save and load integration</name>
  <files>
    Assets/Scripts/MonoBehaviours/Save/SaveData.cs
    Assets/Scripts/MonoBehaviours/Save/SaveManager.cs
    Assets/Scripts/States/GameOverState.cs
    Assets/Scripts/States/PlayingState.cs
  </files>
  <action>
    **SaveData.cs** -- Plain C# class (NOT a MonoBehaviour):
    - `[System.Serializable]` attribute.
    - Fields:
      - `public int SaveVersion = 1;` -- for future migration support (SAVE-05)
      - `public long TotalCredits;` -- persistent credits across all runs (ECON-03)
      - `public int CurrentLevel = 1;` -- Phase 6 will use for level progression
    - NOTE on `long`: JsonUtility's handling of `long` is ambiguous. If it fails during testing, the executor should change to `public double TotalCredits;` and cast to/from `long` in save/load methods. Add a comment noting this.

    **SaveManager.cs** -- MonoBehaviour (singleton pattern):
    - `public static SaveManager Instance { get; private set; }`
    - `private const string SaveFileName = "astrominer_save.json";`
    - `private SaveData _currentSave;`
    - `Awake()`: singleton guard (same pattern as GameManager). Set `_currentSave = Load();`.
    - `public SaveData CurrentSave => _currentSave;`
    - `public void Save(SaveData data)`:
      - `string json = JsonUtility.ToJson(data, true);` (pretty-print for debugging)
      - Build path: use `Application.persistentDataPath` on all platforms. On WebGL this maps to Emscripten VFS which syncs to IndexedDB.
      - `string path = System.IO.Path.Combine(Application.persistentDataPath, SaveFileName);`
      - `System.IO.File.WriteAllText(path, json);`
      - `WebGLHelper.FlushSaveData();` -- no-op on non-WebGL (SAVE-04)
      - Wrap in try/catch. On failure, log error and fallback to `PlayerPrefs.SetString("astrominer_save", json); PlayerPrefs.Save();` as documented in research.
    - `public SaveData Load()`:
      - Build path same as Save.
      - If `System.IO.File.Exists(path)`: read JSON, `JsonUtility.FromJson<SaveData>(json)`, return result.
      - Else if `PlayerPrefs.HasKey("astrominer_save")`: fallback read from PlayerPrefs (handles case where File.IO failed previously).
      - Else: return `new SaveData()` (fresh save).
      - Wrap in try/catch. On failure, return `new SaveData()`.
    - `public void AutoSave()`:
      - Read GameStateData.Credits from ECS singleton.
      - Update `_currentSave.TotalCredits = credits;`
      - Call `Save(_currentSave);`
      - Log: `Debug.Log($"SaveManager: Auto-saved. Credits: {credits}");`
    - `public void LoadIntoECS()`:
      - Read `_currentSave.TotalCredits`.
      - Write to GameStateData.Credits in ECS singleton.
      - Log the loaded values.

    **GameOverState.cs** -- Add auto-save trigger:
    - In `Enter()`, after showing ResultsScreen, call `SaveManager.Instance?.AutoSave();` (SAVE-02).
    - This auto-saves credits at end of every run.

    **PlayingState.cs** -- Add save load on first run:
    - Add a private `bool _isFirstRun = true;` (static, persists across state re-entries within same session).
    - Actually, better approach: In `Enter()`, if this is the very first run of the session (detected by checking if SaveManager.Instance.CurrentSave has loaded credits > 0 and GameStateData.Credits == 0), call `SaveManager.Instance.LoadIntoECS()` to restore saved credits before snapshotting CreditsAtRunStart.
    - Simpler: Just always call `SaveManager.Instance?.LoadIntoECS()` on the first Enter() call. Use a `static bool _saveLoaded = false;` flag. On first enter, if `!_saveLoaded`, load and set flag. This ensures saved credits from prior session appear before the first run starts.
    - After loading, snapshot `GameManager.Instance.CreditsAtRunStart = gameState.Credits;` so HUDController computes correct "credits this run".

    NOTE: SaveManager MonoBehaviour needs to be added to a GameObject in the scene (or created programmatically). The executor should add it to the GameManager GameObject or create a new "SaveManager" GameObject. Note in summary as user setup or use CoPlay MCP.
  </action>
  <verify>
    All 4 files exist. Grep confirms:
    - `SaveData.cs` contains `SaveVersion`, `TotalCredits`, `CurrentLevel`, `[System.Serializable]`
    - `SaveManager.cs` contains `WebGLHelper.FlushSaveData`, `JsonUtility.ToJson`, `File.WriteAllText`, `PlayerPrefs` fallback, `AutoSave`, `LoadIntoECS`
    - `GameOverState.cs` contains `AutoSave`
    - `PlayingState.cs` contains `LoadIntoECS` or `_saveLoaded`
  </verify>
  <done>
    Save system persists credits to JSON at Application.persistentDataPath with WebGL IndexedDB flush. Auto-save fires on every run end. Credits restore from save on game start. Fallback to PlayerPrefs if File.IO fails on any platform.
  </done>
</task>

</tasks>

<verification>
- SaveData has SaveVersion = 1, TotalCredits (long), CurrentLevel (int)
- SaveManager.Save() writes JSON to persistentDataPath and calls WebGLHelper.FlushSaveData()
- SaveManager.Load() reads from file with PlayerPrefs fallback
- GameOverState.Enter() triggers SaveManager.AutoSave()
- PlayingState.Enter() loads saved data into ECS on first run of session
- Save/Load wrapped in try/catch for robustness
</verification>

<success_criteria>
After completing a run, closing the application (or refreshing WebGL), and reopening, the player's credit total from the previous session is restored. Auto-save fires on every run completion. Save file at persistentDataPath contains valid JSON with SaveVersion, TotalCredits, and CurrentLevel.
</success_criteria>

<output>
After completion, create `.planning/phases/03-collection-economy-and-session/03-03-SUMMARY.md`
</output>
