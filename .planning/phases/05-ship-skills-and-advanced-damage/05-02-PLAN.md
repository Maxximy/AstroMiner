---
phase: 05-ship-skills-and-advanced-damage
plan: 02
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - Assets/Scripts/MonoBehaviours/UI/SkillBarController.cs
  - Assets/Scripts/MonoBehaviours/Rendering/SkillVFXManager.cs
  - Assets/Scripts/MonoBehaviours/Rendering/BurningEffectManager.cs
  - Assets/Scripts/MonoBehaviours/Core/UISetup.cs
  - Assets/Scripts/MonoBehaviours/Bridge/FeedbackEventBridge.cs
  - Assets/Scripts/MonoBehaviours/Audio/AudioManager.cs
  - Assets/Scripts/MonoBehaviours/Rendering/MiningCircleVisual.cs
autonomous: false
requirements: [SKIL-05, SKIL-06, DMGS-03]

must_haves:
  truths:
    - "Four skill slots are visible in a horizontal row at bottom center of the screen"
    - "Each slot shows a keybind badge (1, 2, 3, 4) and a radial cooldown sweep overlay"
    - "Clicking a skill slot button activates the corresponding skill"
    - "Cooldown remaining is displayed as a number on each cooling-down slot"
    - "Laser Burst shows a cyan beam from ship to mouse for a brief flash"
    - "Chain Lightning shows a jagged blue-white line from ship through chain targets"
    - "EMP Pulse shows an expanding particle burst at target position"
    - "Overcharge visually changes the mining circle to gold/yellow and scales it up"
    - "Burning asteroids have ember particle trails"
    - "Each skill plays a distinct activation sound"
    - "Critical hits play a distinct crit sound"
  artifacts:
    - path: "Assets/Scripts/MonoBehaviours/UI/SkillBarController.cs"
      provides: "Skill bar UI with 4 slots, radial cooldown, click activation"
    - path: "Assets/Scripts/MonoBehaviours/Rendering/SkillVFXManager.cs"
      provides: "Pooled skill visual effects (beam, lightning, blast, overcharge glow)"
    - path: "Assets/Scripts/MonoBehaviours/Rendering/BurningEffectManager.cs"
      provides: "Ember particle tracking on burning asteroid entities"
  key_links:
    - from: "Assets/Scripts/MonoBehaviours/Bridge/FeedbackEventBridge.cs"
      to: "SkillVFXManager + AudioManager"
      via: "DrainSkillEvents dispatches to VFX and audio"
      pattern: "SkillVFXManager.*Play.*AudioManager.*PlaySkillSfx"
    - from: "Assets/Scripts/MonoBehaviours/UI/SkillBarController.cs"
      to: "SkillInputData singleton + SkillCooldownData singleton"
      via: "Button onClick writes activation, LateUpdate reads cooldowns for fill"
      pattern: "SkillInputData.*fillAmount.*SkillCooldownData"
    - from: "Assets/Scripts/MonoBehaviours/Rendering/MiningCircleVisual.cs"
      to: "OverchargeBuffData singleton"
      via: "Reads buff state to change color and scale"
      pattern: "OverchargeBuffData.*RemainingDuration"
---

<objective>
Build the skill bar UI, all skill visual effects, DoT ember particles, audio wiring, and Overcharge visual feedback -- the complete presentation layer for Phase 5 skills.

Purpose: Plan 01 built the ECS damage backend. This plan adds everything the player sees and hears: a 4-slot skill bar with radial cooldown sweeps, laser beams, chain lightning arcs, EMP particle blasts, Overcharge glow on the mining circle, ember trails on burning asteroids, and skill activation + crit hit sounds.

Output: 3 new MonoBehaviour files (SkillBarController, SkillVFXManager, BurningEffectManager), 4 modified files (UISetup, FeedbackEventBridge, AudioManager, MiningCircleVisual)
</objective>

<execution_context>
@C:/Users/max/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/max/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ship-skills-and-advanced-damage/05-RESEARCH.md
@.planning/phases/05-ship-skills-and-advanced-damage/05-01-SUMMARY.md

Key existing files to read before implementing:
@Assets/Scripts/MonoBehaviours/Core/UISetup.cs
@Assets/Scripts/MonoBehaviours/Bridge/FeedbackEventBridge.cs
@Assets/Scripts/MonoBehaviours/Audio/AudioManager.cs
@Assets/Scripts/MonoBehaviours/Rendering/MiningCircleVisual.cs
@Assets/Scripts/MonoBehaviours/Rendering/ExplosionManager.cs
@Assets/Scripts/ECS/Components/SkillComponents.cs
@Assets/Scripts/ECS/Components/FeedbackComponents.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SkillBarController UI, SkillVFXManager, BurningEffectManager, extend FeedbackEventBridge and AudioManager, modify MiningCircleVisual for Overcharge</name>
  <files>
    Assets/Scripts/MonoBehaviours/UI/SkillBarController.cs
    Assets/Scripts/MonoBehaviours/Rendering/SkillVFXManager.cs
    Assets/Scripts/MonoBehaviours/Rendering/BurningEffectManager.cs
    Assets/Scripts/MonoBehaviours/Core/UISetup.cs
    Assets/Scripts/MonoBehaviours/Bridge/FeedbackEventBridge.cs
    Assets/Scripts/MonoBehaviours/Audio/AudioManager.cs
    Assets/Scripts/MonoBehaviours/Rendering/MiningCircleVisual.cs
  </files>
  <action>
**1. Create `Assets/Scripts/MonoBehaviours/UI/SkillBarController.cs`** (namespace `MonoBehaviours.UI`):

A MonoBehaviour that manages the skill bar UI. Created programmatically by UISetup.

**Public Initialize method** called by UISetup:
```csharp
public void Initialize(Image[] cooldownOverlays, TextMeshProUGUI[] cooldownTexts,
                       Button[] skillButtons, GameObject skillBarRoot)
```
Stores references to 4 overlay Images, 4 cooldown texts, 4 buttons, and the root GO.

**Button click handlers:** Each button writes to the SkillInputData singleton:
- On click, get EntityManager, find SkillInputData singleton entity, read current data, set `SkillNPressed = true`, write back.
- This is the same pattern as InputBridge but triggered by UI instead of keyboard.
- Use lazy initialization for ECS access (same `_ecsInitialized` pattern as FeedbackEventBridge).

**LateUpdate reads SkillCooldownData singleton** for UI updates:
- For each skill slot (0-3):
  - Read `SkillNRemaining` and `SkillNMaxCooldown`.
  - `overlayImage.fillAmount = maxCooldown > 0 ? remaining / maxCooldown : 0f;`
  - `cooldownText.text = remaining > 0 ? Mathf.CeilToInt(remaining).ToString() : "";`
- Show/hide the skill bar root based on game phase (visible only during Playing).

**Ready flash:** When a skill transitions from cooldown to ready (remaining crosses 0), briefly flash the overlay white at 0.5 alpha for 0.3s, then fade to transparent. Track previous `remaining > 0` per slot.

**2. Extend `Assets/Scripts/MonoBehaviours/Core/UISetup.cs`:**

Add a new `CreateSkillBarCanvas()` method called from `Awake()` (after existing canvas creation). Add `public SkillBarController SkillBarController { get; private set; }` property.

The method creates:
- A new Canvas "SkillBarCanvas" (ScreenSpace-Overlay, Sort Order 15 -- above HUD).
- A horizontal panel anchored bottom-center: `anchorMin=(0.5, 0)`, `anchorMax=(0.5, 0)`, `pivot=(0.5, 0)`, `anchoredPosition=(0, 20)`, `sizeDelta=(320, 70)`.
- A `HorizontalLayoutGroup` with spacing=8, childAlignment=MiddleCenter.
- 4 skill slots, each 70x70:
  - **Background Image**: Dark gray `(0.15, 0.15, 0.15, 0.9)`.
  - **Icon Image child**: Colored shape representing the skill.
    - Slot 0 (Laser): Cyan `(0, 1, 1, 0.8)` -- stretch a narrow rect horizontally as a "beam line" icon. Use a simple filled Image with `sizeDelta=(50, 8)`.
    - Slot 1 (Chain): Blue `(0.5, 0.7, 1, 0.8)` -- zigzag effect: 3 narrow rects at angles (or just a blue filled square as simple icon).
    - Slot 2 (EMP): Purple `(0.7, 0.4, 1, 0.8)` -- circle ring: use Image.Type.Filled Radial360 at partial fill or just a filled circle.
    - Slot 3 (Overcharge): Gold `(1, 0.8, 0, 0.8)` -- upward arrow or star. Simple filled rect as placeholder.
  - **Cooldown overlay Image child**: Full-size child with `Image.Type = Filled`, `fillMethod = Radial360`, `fillOrigin = Top`, `fillClockwise = true`, `fillAmount = 0`, color `(0, 0, 0, 0.7)`.
  - **Cooldown text child**: TextMeshProUGUI centered, fontSize=16, white, empty initial text.
  - **Keybind badge child**: Small TextMeshProUGUI at bottom-right corner, `anchorMin/Max=(1,0)`, `pivot=(1,0)`, fontSize=10, gray color `(0.6, 0.6, 0.6, 0.8)`, text = "1"/"2"/"3"/"4".
  - **Button component** on the slot root: targetGraphic = background Image.

After creating all 4 slots, add SkillBarController component and call Initialize with the arrays.

Wire UI click SFX on buttons: `button.onClick.AddListener(() => AudioManager.Instance?.PlayUIClick());`

**3. Create `Assets/Scripts/MonoBehaviours/Rendering/SkillVFXManager.cs`** (namespace `MonoBehaviours.Rendering`):

Self-instantiates via `[RuntimeInitializeOnLoadMethod(RuntimeInitializeLoadType.AfterSceneLoad)]` (same pattern as ExplosionManager).

**Pooled VFX objects created in Start:**

- **Laser beam**: A child GameObject with a LineRenderer (2 points), HDR cyan material `(0, 1, 1) * 6`, `startWidth=0.3`, `endWidth=0.15`. Initially disabled.
- **Chain lightning**: A child GameObject with a LineRenderer (max 6 points -- ship + up to 5 targets), HDR blue-white `(0.5, 0.7, 1) * 5`, `startWidth=0.15`, `endWidth=0.1`. Initially disabled.
- **EMP blast**: A child GameObject with a ParticleSystem. Configuration:
  - Emission: burst of 30 particles
  - Shape: Sphere, radius 0.5
  - Start lifetime: 0.4s
  - Start speed: `EmpPulseRadius * 2` (expand to fill radius visually)
  - Start size: 0.3
  - Start color: blue-purple `(0.7, 0.4, 1, 1)`
  - Renderer: Particles/Standard Unlit material
  - Initially stopped.

**Public methods called by FeedbackEventBridge:**
- `PlayLaserBurst(Vector3 origin, Vector3 target)`: Set LineRenderer positions (Y=0.1 for slight height), enable, start coroutine to disable after 0.15s.
- `PlayChainLightning(Vector3 origin, Vector3[] targets, int count)`: Set LineRenderer positions with slight random perpendicular offset (0.15 units) on intermediate points for jagged look. Enable, disable after 0.2s.
- `PlayEmpPulse(Vector3 position)`: Move ParticleSystem to position, call `Play()`.
- `PlayOverchargeActivation()`: No-op for now (Overcharge visual is handled by MiningCircleVisual reading OverchargeBuffData).

LineRenderer materials: Create via `new Material(Shader.Find("Universal Render Pipeline/Unlit"))` with HDR color, same pattern as MiningCircleVisual.

**4. Create `Assets/Scripts/MonoBehaviours/Rendering/BurningEffectManager.cs`** (namespace `MonoBehaviours.Rendering`):

Self-instantiates via RuntimeInitializeOnLoadMethod. Manages pooled ember ParticleSystems that track burning asteroids.

**Pool**: Pre-create 20 child GameObjects each with a ParticleSystem:
- Emission: rate over time = 8-12 particles/sec
- Shape: Sphere, radius 0.3
- Start lifetime: 0.6s
- Start speed: 0.5
- Start size: 0.15-0.25
- Start color: orange-to-red gradient `(1, 0.5, 0, 1)` to `(1, 0.2, 0, 0.5)`
- Color over lifetime: fade to transparent
- Size over lifetime: shrink
- Gravity modifier: -0.3 (float upward -- negative Y)
- Renderer: default particle material or Particles/Standard Unlit

**LateUpdate** (with lazy ECS init pattern):
- Query all entities with `BurningData` AND `AsteroidTag` (to get their LocalTransform positions). Use an EntityQuery for `BurningData` + `LocalTransform`.
- For each burning entity: if not already tracked, get a particle GO from pool, enable it, start playing.
- Position each active particle GO at the entity's world position `(pos.x, 0.1, pos.z)`.
- For tracked entities that no longer have BurningData (removed by BurningDamageSystem): stop particles, return to pool.
- Use a `Dictionary<Entity, GameObject>` for tracking (same pattern as AsteroidRenderer).

**5. Extend `Assets/Scripts/MonoBehaviours/Bridge/FeedbackEventBridge.cs`:**

- Add `private EntityQuery skillBufferQuery;` field.
- In the lazy init block, add: `skillBufferQuery = em.CreateEntityQuery(typeof(SkillEvent));`
- Add `DrainSkillEvents()` method called from LateUpdate after existing drains.
- In DrainSkillEvents:
  ```csharp
  if (skillBufferQuery.CalculateEntityCount() == 0) return;
  var entity = skillBufferQuery.GetSingletonEntity();
  var buffer = em.GetBuffer<SkillEvent>(entity);

  for (int i = 0; i < buffer.Length; i++)
  {
      var evt = buffer[i];
      switch (evt.SkillType)
      {
          case 0: // Laser Burst
              SkillVFXManager.Instance?.PlayLaserBurst(
                  new Vector3(evt.OriginPos.x, 0.1f, evt.OriginPos.y),
                  new Vector3(evt.TargetPos.x, 0.1f, evt.TargetPos.y));
              AudioManager.Instance?.PlaySkillSfx(0);
              break;
          case 1: // Chain Lightning
              var targets = new Vector3[evt.ChainCount + 1];
              targets[0] = new Vector3(evt.TargetPos.x, 0.1f, evt.TargetPos.y);
              if (evt.ChainCount >= 1) targets[1] = new Vector3(evt.Chain1.x, 0.1f, evt.Chain1.y);
              if (evt.ChainCount >= 2) targets[2] = new Vector3(evt.Chain2.x, 0.1f, evt.Chain2.y);
              if (evt.ChainCount >= 3) targets[3] = new Vector3(evt.Chain3.x, 0.1f, evt.Chain3.y);
              if (evt.ChainCount >= 4) targets[4] = new Vector3(evt.Chain4.x, 0.1f, evt.Chain4.y);
              SkillVFXManager.Instance?.PlayChainLightning(
                  new Vector3(evt.OriginPos.x, 0.1f, evt.OriginPos.y),
                  targets, evt.ChainCount + 1);
              AudioManager.Instance?.PlaySkillSfx(1);
              break;
          case 2: // EMP Pulse
              SkillVFXManager.Instance?.PlayEmpPulse(
                  new Vector3(evt.TargetPos.x, 0.1f, evt.TargetPos.y));
              AudioManager.Instance?.PlaySkillSfx(2);
              break;
          case 3: // Overcharge
              SkillVFXManager.Instance?.PlayOverchargeActivation();
              AudioManager.Instance?.PlaySkillSfx(3);
              break;
      }
  }
  buffer.Clear();
  ```
- Also extend DrainDamageEvents: add a separate crit sound. When `evt.Type == DamageType.Critical`, call `AudioManager.Instance?.PlayCritHit(pos);` alongside the existing CameraShake.

**6. Extend `Assets/Scripts/MonoBehaviours/Audio/AudioManager.cs`:**

- Add clip fields: `private AudioClip critHitClip;` and `private AudioClip[] skillClips;`
- In Start, load:
  ```csharp
  critHitClip = Resources.Load<AudioClip>("Audio/SFX/CritHit");
  skillClips = new AudioClip[]
  {
      Resources.Load<AudioClip>("Audio/SFX/SkillLaser"),
      Resources.Load<AudioClip>("Audio/SFX/SkillChain"),
      Resources.Load<AudioClip>("Audio/SFX/SkillEMP"),
      Resources.Load<AudioClip>("Audio/SFX/SkillOvercharge")
  };
  ```
- Replace the stub `PlaySkillSfx(int skillType)` with real implementation:
  ```csharp
  public void PlaySkillSfx(int skillType)
  {
      if (skillType < 0 || skillClips == null || skillType >= skillClips.Length) return;
      var camPos = Camera.main != null ? Camera.main.transform.position : Vector3.zero;
      PlaySfx(skillClips[skillType], camPos, 0.7f);
  }
  ```
- Add `PlayCritHit(Vector3 position)`:
  ```csharp
  public void PlayCritHit(Vector3 position)
  {
      PlaySfx(critHitClip, position, 0.6f, 1.2f); // Slightly higher pitch for crit
  }
  ```
- Note: Audio clips may not exist yet (Resources.Load returns null gracefully). The AudioManager's graceful degradation handles this -- all PlaySfx calls silently return if clip is null.

**7. Modify `Assets/Scripts/MonoBehaviours/Rendering/MiningCircleVisual.cs`:**

Add Overcharge visual feedback:
- Add field `private Entity overchargeBuffEntity;` and `private Color baseColor;` and `private float baseRadius;`.
- In the Initialize coroutine, after getting `miningConfigEntity`, add:
  ```csharp
  overchargeBuffEntity = em.CreateEntityQuery(typeof(OverchargeBuffData)).GetSingletonEntity();
  baseColor = new Color(0f, 1f, 1f) * HDRIntensity; // cyan HDR
  baseRadius = config.Radius;
  ```
- In Update, after setting position and radius, add:
  ```csharp
  var overcharge = em.GetComponentData<OverchargeBuffData>(overchargeBuffEntity);
  if (overcharge.RemainingDuration > 0)
  {
      // Overcharge active: gold color, scaled radius
      float overchargeRadius = config.Radius * overcharge.RadiusMultiplier;
      transform.localScale = Vector3.one * overchargeRadius;
      circleMaterial.SetColor("_BaseColor", new Color(1f, 0.8f, 0f) * HDRIntensity * 1.5f);
  }
  else
  {
      // Normal: cyan color, base radius
      transform.localScale = Vector3.one * config.Radius;
      circleMaterial.SetColor("_BaseColor", baseColor);
  }
  ```
  Replace the existing `transform.localScale = Vector3.one * config.Radius;` line inside the `if (input.MouseValid)` block with this logic.

Add `using ECS.Components;` for OverchargeBuffData if not already imported.
  </action>
  <verify>
Open Unity Editor, verify zero compilation errors. Enter Play Mode. Verify:
1. Skill bar appears at bottom center with 4 slots showing keybind badges 1-4
2. Clicking a skill button activates it (same as pressing the key)
3. After activation, radial cooldown sweep fills the slot dark, countdown number visible
4. When cooldown completes, brief white flash on the slot
5. Laser Burst shows a cyan beam flash from ship toward mouse
6. Chain Lightning shows a jagged blue-white line through targets
7. EMP Pulse shows an expanding purple-blue particle burst
8. Overcharge turns the mining circle gold/yellow and visibly larger for 5 seconds
9. Burning asteroids show ember particle trails
10. Skill activation plays a sound (may be silent if audio clips not yet created -- graceful degradation)
11. Critical hits play a distinct higher-pitched sound
  </verify>
  <done>
Skill bar UI visible with 4 slots, radial cooldown fill, keybind badges, and click activation. All four skill VFX render correctly. Mining circle changes to gold during Overcharge. Burning asteroids show ember particles. FeedbackEventBridge dispatches SkillEvents to VFX and audio. AudioManager has crit and skill SFX methods (gracefully silent if clips missing).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete Phase 5 skill and damage system</name>
  <files>None (verification only)</files>
  <action>
Verify complete Phase 5: four active combat skills (Laser Burst, Chain Lightning, EMP Pulse, Overcharge) with keyboard and UI activation, cooldown UI, critical hit system, DoT burning with ember particles, and all visual/audio effects.

Steps to verify:
1. Enter Play Mode and wait for a run to start
2. Press 1 (Laser Burst): A cyan beam should flash from the ship toward your mouse. Asteroids in the beam's path take damage. The skill bar slot 1 shows a filling dark radial cooldown overlay.
3. Press 2 (Chain Lightning): A jagged blue-white line connects from the ship through multiple nearby asteroids. Several asteroids near the mouse take damage.
4. Press 3 (EMP Pulse): An expanding purple-blue particle burst appears at the mouse position. All asteroids in the area take damage.
5. Press 4 (Overcharge): The mining circle turns gold/yellow and becomes larger. Mining damage numbers should be noticeably bigger for ~5 seconds, then revert to cyan.
6. Watch for "CRIT!" popups: While mining normally, some damage numbers should occasionally appear as yellow "CRIT!" text (~8% of hits). These should also trigger a subtle screen shake.
7. Watch for DoT burning: After hitting asteroids with Laser or EMP, those asteroids should show small orange ember particles trailing from them, and continue taking periodic damage ticks.
8. Click skill bar buttons: Clicking the 4 skill slots at the bottom of the screen should activate skills just like pressing the keyboard keys.
9. Cooldown enforcement: After using a skill, verify you cannot reuse it until the cooldown timer (shown as a number on the slot) reaches zero. The slot should flash briefly when ready again.
10. Phase gating: When the run timer expires and the game transitions to Collecting/GameOver, skills should NOT activate.
  </action>
  <verify>User visually confirms all 10 verification steps pass in Unity Play Mode.</verify>
  <done>User types "approved" confirming all Phase 5 skill, crit, DoT, and UI systems work correctly.</done>
</task>

</tasks>

<verification>
1. **Skill bar visible**: 4 slots at bottom center, each with icon, keybind badge, and cooldown overlay.
2. **All 4 skills activate**: Keyboard (1-4) and click activation both work.
3. **Radial cooldown**: Dark overlay sweeps clockwise, countdown number shows remaining seconds.
4. **Laser VFX**: Cyan beam flash from ship to mouse, 0.15s duration.
5. **Chain Lightning VFX**: Jagged blue-white line through 4-5 target asteroids, 0.2s duration.
6. **EMP VFX**: Expanding purple-blue particle burst at target, 0.4s duration.
7. **Overcharge VFX**: Mining circle turns gold, scales up 1.5x for 5s, reverts to cyan.
8. **Crit popups**: Yellow "CRIT!" at ~8% rate with camera shake and distinct sound.
9. **Ember particles**: Small orange particles trail from burning asteroids after Laser/EMP hits.
10. **Audio**: Skill activation sounds (gracefully silent if clips missing), crit hit sound.
11. **No compilation errors**, no runtime exceptions.
</verification>

<success_criteria>
- Skill bar UI renders correctly with 4 slots and all interactive elements
- All 4 skill VFX play with correct visuals (beam, arcs, blast, glow)
- Mining circle visually changes during Overcharge buff
- Burning asteroids show ember particle trails
- FeedbackEventBridge dispatches SkillEvents to VFX and audio managers
- Critical hit sound plays on crit events
- User approves the complete Phase 5 experience in checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/05-ship-skills-and-advanced-damage/05-02-SUMMARY.md`
</output>
